<%= csrf_meta_tags %>

<div class="report-page">
  <nav class="breadcrumb">
    <%= link_to "Dashboard", root_path %>
    <span>/</span>
    <span><%= @categories[@category][:name] %></span>
    <span>/</span>
    <span><%= @report_info[:name] %></span>
  </nav>

  <div class="report-header">
    <div class="report-info">
      <h2><%= @report_info[:name] %></h2>
      <p><%= @report_info[:description] %></p>
    </div>

    <div class="report-actions">
      <button class="btn btn-primary" onclick="runReport('<%= @category %>', '<%= @report_key %>', this)">
        â–¶ Run Report
      </button>

      <!-- Download dropdown -->
      <div class="dropdown" id="download-dropdown" style="display: none;">
        <button class="btn btn-secondary" onclick="toggleDropdown()">
          â¬‡ Download
        </button>
        <div class="dropdown-menu" id="dropdown-menu">
          <a href="#" onclick="downloadReport('txt'); return false;">ðŸ“„ Text (.txt)</a>
          <a href="#" onclick="downloadReport('csv'); return false;">ðŸ“Š CSV (.csv)</a>
          <a href="#" onclick="downloadReport('json'); return false;">ðŸ“‹ JSON (.json)</a>
        </div>
      </div>

      <% if PgReports.config.telegram_configured? %>
        <button class="btn btn-telegram" onclick="sendToTelegram('<%= @category %>', '<%= @report_key %>', this)" id="telegram-btn" style="display: none;">
          ðŸ“¨ Telegram
        </button>
      <% end %>
      <%= link_to "â† Back", root_path, class: "btn btn-secondary" %>
    </div>
  </div>

  <% if @error %>
    <div class="error-message">
      <strong>Error:</strong> <%= @error %>
    </div>
  <% end %>

  <div class="results-container" id="results-container">
    <div class="results-header">
      <span class="results-title">Results</span>
      <div class="results-meta" id="results-meta">
        <span>Click "Run Report" to fetch data</span>
      </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
      <div class="spinner"></div>
    </div>

    <div id="empty-state" class="empty-state" style="display: none;">
      <div class="empty-state-icon">âœ“</div>
      <p>No issues found. Everything looks good!</p>
    </div>

    <div class="results-table-wrapper">
      <table class="results-table" id="results-table">
        <thead id="results-head"></thead>
        <tbody id="results-body"></tbody>
      </table>
    </div>
  </div>
</div>

<style>
  .dropdown {
    position: relative;
    display: inline-block;
  }

  .dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 4px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    min-width: 160px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    z-index: 100;
    overflow: hidden;
  }

  .dropdown-menu.show {
    display: block;
  }

  .dropdown-menu a {
    display: block;
    padding: 0.75rem 1rem;
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.875rem;
    transition: all 0.15s;
  }

  .dropdown-menu a:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  .dropdown-menu a:not(:last-child) {
    border-bottom: 1px solid var(--border-color);
  }

  /* Clickable rows */
  .results-table tbody tr.data-row {
    cursor: pointer;
    transition: all 0.15s;
  }

  .results-table tbody tr.data-row:hover {
    background: var(--bg-secondary);
  }

  .results-table tbody tr.data-row.expanded {
    background: var(--bg-tertiary);
  }

  .results-table tbody tr.data-row td:first-child::before {
    content: 'â–¸';
    display: inline-block;
    margin-right: 0.5rem;
    color: var(--text-muted);
    transition: transform 0.2s;
  }

  .results-table tbody tr.data-row.expanded td:first-child::before {
    content: 'â–¾';
    color: var(--accent-purple);
  }

  /* Expanded row detail */
  .results-table tbody tr.detail-row {
    display: none;
  }

  .results-table tbody tr.detail-row.show {
    display: table-row;
  }

  .results-table tbody tr.detail-row td {
    padding: 0;
    background: var(--bg-primary);
    border-bottom: 2px solid var(--accent-purple);
  }

  .row-detail {
    padding: 1.25rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
  }

  .row-detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .row-detail-item.full-width {
    grid-column: 1 / -1;
  }

  .row-detail-label {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .row-detail-value {
    padding: 0.75rem 1rem;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
    color: var(--text-primary);
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 200px;
    overflow-y: auto;
  }

  .row-detail-value.query {
    color: var(--accent-green);
    max-height: 300px;
  }

  .row-detail-value.number {
    color: var(--accent-blue);
  }

  /* Copy button */
  .copy-btn {
    align-self: flex-start;
    margin-top: 0.375rem;
    padding: 0.25rem 0.625rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-muted);
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.15s;
  }

  .copy-btn:hover {
    background: var(--accent-purple);
    border-color: var(--accent-purple);
    color: white;
  }

  /* Row hint */
  .row-hint {
    display: inline-block;
    margin-left: 0.5rem;
    padding: 0.125rem 0.5rem;
    background: var(--bg-tertiary);
    border-radius: 4px;
    font-size: 0.7rem;
    color: var(--text-muted);
  }
</style>

<script>
  let currentReportData = null;
  const category = '<%= @category %>';
  const reportKey = '<%= @report_key %>';

  function toggleDropdown() {
    document.getElementById('dropdown-menu').classList.toggle('show');
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('download-dropdown');
    if (dropdown && !dropdown.contains(e.target)) {
      document.getElementById('dropdown-menu')?.classList.remove('show');
    }
  });

  function downloadReport(format) {
    document.getElementById('dropdown-menu').classList.remove('show');
    window.location.href = `/pg_reports/${category}/${reportKey}/download?format=${format}`;
  }

  function toggleRow(rowIndex) {
    const dataRow = document.getElementById(`data-row-${rowIndex}`);
    const detailRow = document.getElementById(`detail-row-${rowIndex}`);

    if (!dataRow || !detailRow) return;

    const isExpanded = dataRow.classList.contains('expanded');

    // Collapse all other rows
    document.querySelectorAll('.data-row.expanded').forEach(row => {
      row.classList.remove('expanded');
    });
    document.querySelectorAll('.detail-row.show').forEach(row => {
      row.classList.remove('show');
    });

    // Toggle current row
    if (!isExpanded) {
      dataRow.classList.add('expanded');
      detailRow.classList.add('show');
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function copyToClipboard(text, btn) {
    navigator.clipboard.writeText(text).then(() => {
      const originalText = btn.textContent;
      btn.textContent = 'âœ“ Copied!';
      btn.style.background = 'var(--accent-green)';
      btn.style.borderColor = 'var(--accent-green)';
      btn.style.color = 'white';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
        btn.style.borderColor = '';
        btn.style.color = '';
      }, 1500);
    }).catch(() => {
      showToast('Failed to copy', 'error');
    });
  }

  function buildDetailRow(row, columns, rowIndex) {
    let html = '<div class="row-detail">';

    columns.forEach(col => {
      const value = row[col] ?? '';
      const strValue = String(value);
      const isQuery = col === 'query';
      const isNumber = typeof value === 'number' || (!isNaN(parseFloat(value)) && isFinite(value));
      const valueClass = isQuery ? 'query' : (isNumber ? 'number' : '');
      const isLongText = strValue.length > 100 || isQuery;

      html += `
        <div class="row-detail-item${isLongText ? ' full-width' : ''}">
          <span class="row-detail-label">${escapeHtml(col)}</span>
          <div class="row-detail-value ${valueClass}">${escapeHtml(strValue)}</div>
          ${isQuery ? `<button class="copy-btn" onclick="event.stopPropagation(); copyToClipboard(\`${strValue.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`, this)">ðŸ“‹ Copy Query</button>` : ''}
        </div>
      `;
    });

    html += '</div>';
    return html;
  }

  async function runReport(cat, report, button) {
    const tableBody = document.getElementById('results-body');
    const tableHead = document.getElementById('results-head');
    const loadingEl = document.getElementById('loading');
    const emptyEl = document.getElementById('empty-state');
    const metaEl = document.getElementById('results-meta');
    const downloadDropdown = document.getElementById('download-dropdown');
    const telegramBtn = document.getElementById('telegram-btn');

    if (button) {
      button.disabled = true;
      button.innerHTML = '<span class="spinner" style="width:16px;height:16px;border-width:2px;display:inline-block;vertical-align:middle;"></span> Running...';
    }

    if (loadingEl) loadingEl.style.display = 'flex';
    if (emptyEl) emptyEl.style.display = 'none';
    if (tableBody) tableBody.innerHTML = '';
    if (downloadDropdown) downloadDropdown.style.display = 'none';
    if (telegramBtn) telegramBtn.style.display = 'none';

    try {
      const response = await fetch(`/pg_reports/${cat}/${report}/run`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
        }
      });

      const data = await response.json();

      if (loadingEl) loadingEl.style.display = 'none';

      if (data.success) {
        currentReportData = data;

        if (metaEl) {
          metaEl.innerHTML = `
            <span>Total: ${data.total} rows</span>
            <span>Generated: ${data.generated_at}</span>
            <span class="row-hint">Click row to expand</span>
          `;
        }

        // Show download and telegram buttons
        if (downloadDropdown) downloadDropdown.style.display = 'inline-block';
        if (telegramBtn) telegramBtn.style.display = 'inline-flex';

        if (data.data.length === 0) {
          if (emptyEl) emptyEl.style.display = 'block';
        } else {
          // Build table header
          if (tableHead) {
            tableHead.innerHTML = '<tr>' + data.columns.map(col =>
              `<th>${escapeHtml(col)}</th>`
            ).join('') + '</tr>';
          }

          // Build table body with expandable rows
          if (tableBody) {
            let rowsHtml = '';

            data.data.forEach((row, idx) => {
              // Data row
              rowsHtml += `<tr id="data-row-${idx}" class="data-row" onclick="toggleRow(${idx})">`;
              rowsHtml += data.columns.map(col => {
                const value = row[col] ?? '';
                const strValue = String(value);
                const isQuery = col === 'query';
                const displayValue = strValue.length > 80 ? strValue.substring(0, 80) + '...' : strValue;
                return `<td class="${isQuery ? 'query-cell' : ''}">${escapeHtml(displayValue)}</td>`;
              }).join('');
              rowsHtml += '</tr>';

              // Detail row (hidden by default)
              rowsHtml += `<tr id="detail-row-${idx}" class="detail-row">`;
              rowsHtml += `<td colspan="${data.columns.length}">${buildDetailRow(row, data.columns, idx)}</td>`;
              rowsHtml += '</tr>';
            });

            tableBody.innerHTML = rowsHtml;
          }
        }

        showToast('Report generated successfully');
      } else {
        showToast(data.error || 'Failed to run report', 'error');
      }
    } catch (error) {
      if (loadingEl) loadingEl.style.display = 'none';
      showToast('Network error: ' + error.message, 'error');
    }

    if (button) {
      button.disabled = false;
      button.innerHTML = 'â–¶ Run Report';
    }
  }
</script>
