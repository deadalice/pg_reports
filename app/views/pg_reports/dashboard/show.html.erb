<%= csrf_meta_tags %>

<div class="report-page">
  <nav class="breadcrumb">
    <%= link_to "Dashboard", root_path %>
    <span>/</span>
    <span><%= @categories[@category][:name] %></span>
    <span>/</span>
    <span><%= @report_info[:name] %></span>
  </nav>

  <div class="report-header">
    <div class="report-info">
      <h2><%= @report_info[:name] %></h2>
      <p><%= @report_info[:description] %></p>
    </div>

    <div class="report-actions">
      <button class="btn btn-primary" onclick="runReport('<%= @category %>', '<%= @report_key %>', this)">
        ‚ñ∂ Run Report
      </button>

      <!-- Download dropdown -->
      <div class="dropdown" id="download-dropdown" style="display: none;">
        <button class="btn btn-secondary" onclick="toggleDropdown()">
          ‚¨á Download
        </button>
        <div class="dropdown-menu" id="dropdown-menu">
          <a href="#" onclick="downloadReport('txt'); return false;">üìÑ Text (.txt)</a>
          <a href="#" onclick="downloadReport('csv'); return false;">üìä CSV (.csv)</a>
          <a href="#" onclick="downloadReport('json'); return false;">üìã JSON (.json)</a>
        </div>
      </div>

      <% if PgReports.config.telegram_configured? %>
        <button class="btn btn-telegram" onclick="sendToTelegram('<%= @category %>', '<%= @report_key %>', this)" id="telegram-btn" style="display: none;">
          üì® Telegram
        </button>
      <% end %>
      <button class="btn btn-icon" onclick="showIdeSettingsModal()" title="IDE Settings">
        ‚öôÔ∏è
      </button>
      <%= link_to "‚Üê Back", root_path, class: "btn btn-secondary" %>
    </div>
  </div>

  <% if @error %>
    <div class="error-message">
      <strong>Error:</strong> <%= @error %>
    </div>
  <% end %>

  <div class="report-details-grid">
    <!-- Collapsible Documentation Section -->
    <% if @documentation && @documentation[:what].present? %>
      <details class="documentation-section">
        <summary class="documentation-toggle">
          <span class="toggle-icon">‚ñ∂</span>
          <span>üìñ What does this report show?</span>
        </summary>
        <div class="documentation-content">
          <% if @documentation[:what].present? %>
            <div class="doc-block">
              <h4>üìã What</h4>
              <p><%= @documentation[:what] %></p>
            </div>
          <% end %>

          <% if @documentation[:why].present? %>
            <div class="doc-block">
              <h4>‚ùì Why It Matters</h4>
              <p><%= @documentation[:why] %></p>
            </div>
          <% end %>

          <% if @documentation[:nuances].present? %>
            <div class="doc-block">
              <h4>‚ö†Ô∏è Nuances</h4>
              <ul class="nuances-list">
                <% @documentation[:nuances].each do |nuance| %>
                  <li><%= nuance %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <% if @thresholds.present? %>
            <div class="thresholds-block">
              <h4>üìä Thresholds</h4>
              <div class="thresholds-grid">
                <% @thresholds.each do |field, values| %>
                  <div class="threshold-item">
                    <span class="threshold-field"><%= field %></span>
                    <span class="threshold-warning">‚ö†Ô∏è Warning: <%= values[:warning] %></span>
                    <span class="threshold-critical">üî¥ Critical: <%= values[:critical] %></span>
                    <% if values[:inverted] %>
                      <span class="threshold-note">(lower is worse)</span>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </details>
    <% end %>

    <!-- Filter Parameters Section -->
    <% if @report_filters.present? %>
      <div class="filter-section">
        <details class="filter-details">
          <summary class="filter-toggle">
            <span class="toggle-icon">‚ñ∂</span>
            <span>üîç –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</span>
          </summary>
          <div class="filter-content">
            <div class="filter-grid">
              <% @report_filters.each do |name, config| %>
                <div class="filter-item">
                  <label class="filter-label">
                    <%= config[:label] %>
                    <% if config[:description] %>
                      <span class="filter-description"><%= config[:description] %></span>
                    <% end %>
                    <% if config[:is_threshold] && config[:current_config] %>
                      <span class="filter-current-value">(current: <%= config[:current_config] %>)</span>
                    <% end %>
                  </label>
                  <input
                    type="<%= config[:type] == 'integer' ? 'number' : 'text' %>"
                    class="filter-input"
                    data-param="<%= name %>"
                    value="<%= config[:default] %>"
                    <% if config[:type] == 'integer' %>
                      min="0"
                      step="1"
                    <% end %>
                    placeholder="<%= config[:default] %>"
                  >
                </div>
              <% end %>
            </div>
          </div>
        </details>
      </div>
    <% end %>
  </div>

  <!-- Saved Records Section -->
  <div class="saved-records-section" id="saved-records-section" style="display: none;">
    <div class="saved-records-header">
      <span class="saved-records-title">üìå Saved for Comparison</span>
      <button class="btn btn-small btn-muted" onclick="clearAllSavedRecords()">Clear All</button>
    </div>
    <div class="saved-records-list" id="saved-records-list"></div>
  </div>

  <div class="results-container" id="results-container">
    <div class="results-header">
      <span class="results-title">Results</span>
      <div class="results-meta" id="results-meta">
        <span>Click "Run Report" to fetch data</span>
      </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
      <div class="spinner"></div>
    </div>

    <div id="empty-state" class="empty-state" style="display: none;">
      <div class="empty-state-icon">‚úì</div>
      <p>No issues found. Everything looks good!</p>
    </div>

    <div class="top-scroll-wrapper" id="top-scroll-wrapper" style="display: none;">
      <div class="top-scroll-content" id="top-scroll-content"></div>
    </div>
    <div class="results-table-wrapper" id="results-table-wrapper">
      <table class="results-table" id="results-table">
        <thead id="results-head"></thead>
        <tbody id="results-body"></tbody>
      </table>
    </div>
  </div>

  <%= render 'pg_reports/dashboard/show_modals' %>
</div>

<%= render 'pg_reports/dashboard/show_styles' %>

<% if PgReports.config.fake_source_data %>
  <%= render 'pg_reports/dashboard/fake_source_data' %>
<% end %>

<%= render 'pg_reports/dashboard/show_scripts' %>
